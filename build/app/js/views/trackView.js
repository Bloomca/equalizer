/*! Created at 07-12-2014 */
define(["jquery","underscore","backbone","settings"],function(a,b,c,d){function e(a,b){var c=b,e=a||[];return d.filterValues.forEach(function(a,b,f){var g=d.audioContext.createBiquadFilter();g.type="peaking",g.frequency.value=a,g.gain.value=e[b]||0,b&&b!==f.length-1?g.Q.value=d.qValues[b]:g.type=b?"highshelf":"lowshelf",c&&c.connect(g),c=g,d.filters.push(g)}),c}var f=c.View.extend({tagName:"li",initialize:function(){var a=this;this.on("stopMusic",this.playMusic),this.listenTo(this.model,"play",this.playMusic),this.on("stop",function(){a.playMusic(),a.audio=null})},events:{"click .play":"clickOnPlay"},template:b.template(a("#track-tmpl").html()),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},clickOnPlay:function(){d.startApp||(d.trigger("start:app"),d.startApp=!0),d.trigger(this.model.get("play")?"play:pause":"play:resume"),this.playMusic()},playMusic:function(){this.model.get("play")?(this.audio.pause(),this.model.set({play:!1})):(d.view&&d.view!==this&&(d.view.model.get("play")&&d.view.trigger("stopMusic"),this.createAudio()),this.audio||this.createAudio(),this.audio.play(),this.model.set({play:!0}),d.view=this),this.render()},createAudio:function(){function a(){b.audio.duration?(d.duration=b.audio.duration,d.trigger("change:duration")):setTimeout(function(){a()},1e3)}this.audio=document.createElement("audio"),this.audio.src=this.model.get("src");var b=this;a();var c=d.audioContext.createMediaElementSource(this.audio),f=d.volume.gain.value;d.volume=d.audioContext.createGain(),d.analyser=d.audioContext.createAnalyser(),d.volume.gain.value=f,c.connect(d.volume);var g=d.volume,h=[];d.filters.forEach(function(a){h.push(a.gain.value)}),console.log(h),d.filters=[],g=e(h,g),g.connect(d.analyser),d.analyser.connect(d.audioContext.destination)}});return e(),f});